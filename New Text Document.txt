#!/bin/bash
# run: bash harden_patch.sh

echo "[1] Checking for hardcoded secrets..."
grep -R --exclude-dir=node_modules -E "(sk_live|sk_test|supabase|service_role|jwt|SECRET|API_KEY)" . || echo "No secrets found"

echo "[2] Enforcing file validation middleware..."
cat > middleware/validateUpload.js <<'EOF'
export function validateUpload(req, res, next) {
  const file = req.file;
  if (!file) return res.status(400).json({error: "No file uploaded"});
  const allowed = ['application/pdf', 'application/vnd.openxmlformats-officedocument.wordprocessingml.document', 'text/plain'];
  if (!allowed.includes(file.mimetype)) return res.status(400).json({error: "Invalid file type"});
  if (file.size > 10 * 1024 * 1024) return res.status(400).json({error: "File too large"});
  next();
}
EOF

echo "[3] Enforcing auth guard on API routes..."
cat > middleware/authGuard.js <<'EOF'
export function authGuard(req, res, next) {
  if (!req.user) return res.status(401).json({error: "Unauthorized"});
  next();
}
EOF

echo "[4] Stripe secret isolation..."
grep -R "stripe" server/ | grep -v "process.env" && echo "⚠️ Hardcoded Stripe keys detected" || echo "✅ Stripe safe"

echo "[5] Running lint + audit..."
npm install --save-dev eslint
npx eslint . --ext .js,.ts

echo "[DONE] Harden patch complete."